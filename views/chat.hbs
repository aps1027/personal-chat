<style>
    .message {
        height: unset;
        max-width: 200px;
        line-height: 20px;
        padding: 7px 12px;
    }
</style>
<div class="row">
    <div class="col s4" style="padding: 0px 20px;">
        {{#each rooms}}
        <div id="{{_id}}">
            {{#each members}}
            <div class="card row" style="padding: 10px; height:70px; border-radius: 5px; cursor: pointer;"
                onclick="selectTargetUser('{{_id}}')">
                <div class="col" style="padding: 0;">
                    <img src="{{image}}" class="circle responsive-img img-small" style="max-width: 50px;">
                </div>
                <div class="col" style="padding-top: 4px;">
                    <h6>{{displayName}}</h6>
                </div>
            </div>
            {{/each}}
        </div>
        {{/each}}
    </div>
    <div class="col s8" style="height: 580px;border-left: 1px solid #9e9e9e;">
        <div style="height: 60px; border-bottom: 1px solid #9e9e9e;">
            <div class="col" style="padding: 0;">
                <img src="{{targetImage}}" class="circle responsive-img img-small" style="max-width: 50px;"
                    id="select_user_ico">
            </div>
            <div class="col" style="padding-top: 4px;">
                <h6 id="select_user_name">{{targetName}}</h6>
            </div>
        </div>
        <div id="message_area" style="height: 460px; padding: 5px; overflow: auto;">
        </div>
        <div style="width: 100%; height: 60px;border: 1px solid #9e9e9e; padding: 0px 10px;">
            <form onsubmit="sendMessage('{{targetId}}')">
                <div class="col s10">
                    <input type="text" id="message" name="message" placeholder="Type a message">
                </div>
                <div class="col s2">
                    <button type="submit" class="btn teal lighten-2" style="margin-top: 10px;">Send</button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    const CURRENT_ROOM_ID = "{{targetRoomId}}";
    const CURRENT_USER_ID = "{{id}}";
    const socket = io();
    socket.emit('user connect', {
        room_id: CURRENT_ROOM_ID,
        user_id: CURRENT_USER_ID
    });

    socket.on("private message", ({ message, from }) => {
        createMessageChip(from, message);
    });

    socket.on("show noti", ({ room, noti }) => {
        if (room !== CURRENT_ROOM_ID) {
            $(".noti").remove();
            $(`#${room} .card`).append(`
                <div class="col right chip red" style="margin: 8px 0px;">
                    <i class="noti fas fa-bell"></i>
                </div>`);
        }
    });

    $.get(`/api/room-message/${CURRENT_ROOM_ID}`,
        function (data, status) {
            console.log(data);
            data.forEach(({ from, text }) => {
                createMessageChip(from, text);
            });
        }
    );

    const selectTargetUser = (tragetId) => {
        location.href = `/chat/${tragetId}`;
    }

    const sendMessage = (tragetId) => {
        event.preventDefault();
        if (message.value) {
            socket.emit("send message", {
                message: message.value,
                roomId: CURRENT_ROOM_ID,
                from: CURRENT_USER_ID,
                to: tragetId
            });
            createMessageChip(CURRENT_USER_ID, message.value);
            message.value = "";
        }
    }

    const createMessageChip = (from, message) => {
        $("#message_area").append(`
            <div style="width: 100%;display: inline-block;">
                <div class="chip ${from === CURRENT_USER_ID ? 'teal lighten-2 right' : 'left'} message">
                    ${message}
                </div>
            </div>
        `);
        $("#message_area").scrollTop($("#message_area")[0].scrollHeight);
    }
</script>